rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Projects collection
    match /projects/{projectId} {
      allow read: if request.auth.uid == resource.data.userId;
      allow create: if request.auth.uid != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth.uid == resource.data.userId && request.resource.data.userId == resource.data.userId;
      allow delete: if request.auth.uid == resource.data.userId;
    }

    // Templates collection
    match /templates/{templateId} {
      allow read: if request.auth.uid == resource.data.userId;
      allow create: if request.auth.uid != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth.uid == resource.data.userId && request.resource.data.userId == resource.data.userId;
      allow delete: if request.auth.uid == resource.data.userId;
    }

    // Shots collection (scripts, images, videos, sounds)
    match /shots/{shotId} {
      // Allow reading only the user's own shots (with userId field security check)
      allow read: if request.auth.uid != null && (
        // Check document's userId field directly
        resource.data.userId == request.auth.uid ||
        // Or check via projectId from the parent project document
        get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.userId == request.auth.uid
      );
      allow create: if request.auth.uid != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth.uid == resource.data.userId && request.resource.data.userId == resource.data.userId;
      allow delete: if request.auth.uid == resource.data.userId;
    }

    // Assets collection (art direction assets)
    match /assets/{assetId} {
      // Allow reading only the user's own assets
      allow read: if request.auth.uid != null && (
        // Check document's userId field directly
        resource.data.userId == request.auth.uid ||
        // Or check via projectId from the parent project document
        get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.userId == request.auth.uid
      );
      allow create: if request.auth.uid != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth.uid != null && (
        (resource.data.userId == request.auth.uid && request.resource.data.userId == resource.data.userId) ||
        (resource.data.projectId == request.resource.data.projectId && get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.userId == request.auth.uid)
      );
      allow delete: if request.auth.uid == resource.data.userId;
    }
  }
}
